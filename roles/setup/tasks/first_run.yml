%YAML 1.1
---

- name: install necessary apt packages
  become: yes
  apt:
    name: "{{ apt_packages }}"
    state: latest
    update_cache: yes
    install_recommends: yes
    autoclean: yes
  tags: apt-setup

- name: create user
  become: yes 
  user:
    home: /home/validator
    name: validator
    state: present
  tags: user-setup

- name: copy over validator repo
  become: yes
  synchronize:
    src: /var/openstax-validator/response-validation/
    dest: /home/validator/response-validation
  tags:
    - setup-repo

- name: fix permissions
  become: yes
  file:
    path: /home/validator/response-validation
    owner: validator
    group: validator
    recurse: yes
  tags:
    - permissions

- name: virtualenv setup
  become: yes
  become_user: validator
  command: virtualenv -p python3 venv
  args:
    chdir: /home/validator
  tags:
    - virtualenv
    - virtualenv-setup

- name: tag environment as configured
  become: no
  file:
    path: "{{ inventory_dir }}/.setup-complete"
    state: touch
  delegate_to: 127.0.0.1
  tags:
    - configure-confirm
